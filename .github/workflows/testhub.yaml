# GitHub workflow for integrating with TestHub

# After the Tests workflow completes, this workflow will register the test run with TestHub
# It will also listen for PR events to keep TestHub's PR info up to date

name: TestHub Integration

on:
  # Trigger when a workflow run completes
  workflow_run:
    workflows: [Tests]
    types:
      - completed

  # Trigger on PR events to sync PR info (don't need all events)
  pull_request:
    types:
      - edited
      - closed
      - reopened
      - synchronize
      - milestoned
      - demilestoned
      - ready_for_review
      - converted_to_draft

jobs:
  # Job to register completed test runs with TestHub
  register-test-run:
    name: Register Test Run
    runs-on: ubuntu-latest
    env:
      TESTHUB_URL: ${{ secrets.TESTHUB_URL }}
      TESTHUB_TOKEN: ${{ secrets.TESTHUB_TOKEN }}
    # Only run for workflow_run events when env vars are configured
    if: github.event_name == 'workflow_run'
    steps:
      - name: Register test run with TestHub
        # Continue even if this fails - we don't want to fail the workflow
        continue-on-error: true
        run: |
          echo "Registering test run with TestHub..."
          echo "  Repository: ${{ github.repository }}"
          echo "  Run ID: ${{ github.event.workflow_run.id }}"
          echo "  Workflow: ${{ github.event.workflow_run.name }}"
          echo "  Conclusion: ${{ github.event.workflow_run.conclusion }}"

          if [ -z "${TESTHUB_URL}" ]; then
            echo "TESTHUB_URL is not set. Skipping registration."
            exit 1
          fi

          if [ -z "${TESTHUB_TOKEN}" ]; then
            echo "TESTHUB_TOKEN is not set. Skipping registration."
            exit 1
          fi          

          # Build the API URL
          API_URL="${TESTHUB_URL}/api/${{ github.repository }}/register/${{ github.event.workflow_run.id }}"
          
          # Make the API call
          curl -X POST -H "Authorization: Bearer ${TESTHUB_TOKEN}" "${API_URL}"

  # Job to sync PR info with TestHub when PR events occur
  sync-pull-request:
    name: Sync Pull Request
    runs-on: ubuntu-latest
    env:
      TESTHUB_URL: ${{ secrets.TESTHUB_URL }}
      TESTHUB_TOKEN: ${{ secrets.TESTHUB_TOKEN }}

    # Only run for pull_request events when env vars are configured
    if: github.event_name == 'pull_request'
    steps:
      - name: Sync PR info with TestHub
        # Continue even if this fails - we don't want to fail the workflow
        continue-on-error: true
        run: |
          echo "Syncing PR info with TestHub..."
          echo "  Repository: ${{ github.repository }}"
          echo "  PR Number: ${{ github.event.pull_request.number }}"
          echo "  Action: ${{ github.event.action }}"
          echo "  Title: ${{ github.event.pull_request.title }}"

          if [ -z "${TESTHUB_URL}" ]; then
            echo "TESTHUB_URL is not set. Skipping registration."
            exit 1
          fi

          if [ -z "${TESTHUB_TOKEN}" ]; then
            echo "TESTHUB_TOKEN is not set. Skipping registration."
            exit 1
          fi
          
          # Build the API URL
          API_URL="${TESTHUB_URL}/api/${{ github.repository }}/pull-request/refresh/${{ github.event.pull_request.number }}"
          
          # Make the API call
          curl -X POST -H "Authorization: Bearer ${TESTHUB_TOKEN}" "${API_URL}"
