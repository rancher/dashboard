<script lang="ts">
import { PropType } from 'vue';
import { FLEET } from '@shell/config/types';
import LabeledSelect from '@shell/components/form/LabeledSelect.vue';
import FleetResources from '@shell/components/fleet/FleetResources.vue';
import FleetRepo from '@shell/components/formatter/FleetRepo.vue';
import { RcButton } from '@components/RcButton';
import { FleetDashboardState } from '@shell/utils/fleet-types';

export default {
  name: 'FleetDashboardResourceDetails',

  components: {
    LabeledSelect,
    FleetRepo,
    FleetResources,
    RcButton
  },

  props: {
    value: {
      type:     Object,
      required: true
    },

    statePanel: {
      type:     Object as PropType<FleetDashboardState>,
      required: true
    },

    workspace: {
      type:     Object,
      required: true
    }
  },

  data() {
    return {
      FLEET,
      clusterId: ''
    };
  },

  mounted() {
    this.clusterId = this.clusters[0]?.value || '';
  },

  computed: {
    clusters() {
      return this.value.targetClusters.map((cluster: { id: string, nameDisplay: string }) => ({
        label: cluster.nameDisplay,
        value: cluster.id
      }));
    },

    noResources() {
      return !this.value.resourcesStatuses?.length;
    },
  },

  methods: {
    closePanel() {
      this.$store.commit('slideInPanel/close');
    }
  }
};
</script>

<template>
  <div class="details-panel">
    <div
      class="header"
      :data-testid="'fleet-dashboard-resource-details-header'"
    >
      <div class="title">
        <i :class="value.dashboardIcon" />
        <router-link
          class="label"
          :to="value.detailLocation"
        >
          {{ value.id }}
        </router-link>
        <i
          v-if="statePanel.id !== 'success'"
          class="ml-5 state-icon"
          :class="statePanel.icon"
          :style="{ color: statePanel.color }"
        />
      </div>
      <RcButton
        small
        ghost
        data-testid="slide-in-close"
        :aria-label="'slide-in-close'"
        tabindex="0"
        @click="closePanel"
        @keydown.space.enter.stop.prevent="closePanel"
      >
        <i class="icon icon-close" />
      </RcButton>
    </div>

    <template v-if="value.type === FLEET.GIT_REPO">
      <h3>
        {{ t('fleet.dashboard.source') }}
      </h3>
      <div class="mb-15">
        <FleetRepo :row="value" />
      </div>
    </template>

    <h3>
      {{ t('fleet.dashboard.resources') }}
    </h3>
    <FleetResources
      :rows="value.resourcesStatuses"
      :cluster-id="clusterId"
      :search="!noResources"
    >
      <template
        v-if="!noResources"
        #header-left
      >
        <div class="row">
          <div class="col span-10">
            <LabeledSelect
              v-model:value="clusterId"
              :label="'Cluster'"
              :options="clusters"
              :mode="'edit'"
              :disabled="workspace.id === 'fleet-local'"
            />
          </div>
        </div>
      </template>
    </FleetResources>
  </div>
</template>

<style lang="scss">
  .details-panel {
    padding: 10px;

    .sortable-table-header {
      .fixed-header-actions {
        align-items: center;
      }
    }

    .header {
      display: flex;
      align-items: center;
      padding: 0;
      margin: 0 0 20px 0;

      .title {
        display: flex;
        align-items: center;
        flex: 1;
        font-style: normal;
        font-weight: 600;
        font-size: 18px;

        .icon {
          font-size: 2em;
          margin-right: 16px;
        }

        .label {
          margin-right: 8px;
        }

        .state-icon {
          font-size: 1.5em;
        }
      }
    }
  }

  .col {
    .labeled-select {
      min-width: 250px;
    }
  }
</style>
